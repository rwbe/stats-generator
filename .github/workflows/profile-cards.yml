name: Profile cards builder

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all cards'
        required: false
        default: 'false'
        type: boolean
  schedule:
    - cron: '30 3 * * *'
  push:
    branches: [main]
    paths:
      - '.github/config/**'
      - 'statsgen/**'
      - 'assets/templates/**'

permissions:
  contents: write
  issues: write

env:
  PYTHON_VERSION: '3.11'
  CARDS_OUTPUT: 'cards'

jobs:
  preflight:
    name: Validate configuration
    runs-on: ubuntu-latest
    outputs:
      config_valid: ${{ steps.validate.outputs.valid }}
      themes: ${{ steps.themes.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Validate config file
        id: validate
        run: |
          if [ -f ".github/config/profile.yml" ]; then
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "::warning::No .github/config/profile.yml found, using defaults"
          fi

      - name: Detect themes
        id: themes
        run: |
          echo 'matrix=["dark", "light"]' >> $GITHUB_OUTPUT

  build-cards:
    name: Build ${{ matrix.theme }} theme
    needs: preflight
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        theme: ${{ fromJson(needs.preflight.outputs.themes) }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Cache language colors
        uses: actions/cache@v4
        with:
          path: ~/.statsgen/colors.json
          key: lang-colors-${{ hashFiles('statsgen/colors.py') }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate ${{ matrix.theme }} cards
        env:
          GH_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          PROFILE_CONFIG: .github/config/profile.yml
          CARD_THEME: ${{ matrix.theme }}
        run: python -m statsgen --theme ${{ matrix.theme }}

      - name: Upload card artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cards-${{ matrix.theme }}
          path: ${{ env.CARDS_OUTPUT }}/*.svg
          retention-days: 1

  publish:
    name: Publish cards
    needs: build-cards
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ${{ env.CARDS_OUTPUT }}
          merge-multiple: true

      - name: Commit updated cards
        run: |
          git config user.name "statsgen[bot]"
          git config user.email "statsgen[bot]@users.noreply.github.com"
          git add ${{ env.CARDS_OUTPUT }}/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: refresh profile cards [skip ci]"
            git push
          fi

  notify-failure:
    name: Notify on failure
    needs: [preflight, build-cards, publish]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Profile Cards Build Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `The profile cards workflow failed. Check the [Actions log](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`;

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'workflow-failure'
            });

            if (!issues.data.some(i => i.title === title)) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['workflow-failure']
              });
            }
